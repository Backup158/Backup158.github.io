<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Darktide Weapon Customization Edits</title>
  </head>
  <body>
    <button type="button" class="collapsible">Navigation</button>
    <nav class="content">
      <h3 class="navbarHeader"><a href="/index.html">Home</a></h3>
      
        <h3 class="navbarHeader">Documentation Repositories</h3>
        <ul>
          
            <li><a class="" href="/StartupProcess/">Desktop Startup Process</a></li>
          
            <li><a class="" href="/VencordTheme/">Vencord Theme</a></li>
          
            <li><a class="" href="/BashScripts/">Bash Scripts Collection</a></li>
          
            <li><a class="" href="/PagesDocumentation.html">GitHub Pages</a></li>
          
        </ul>
      
        <h3 class="navbarHeader">Modding Documentation</h3>
        <ul>
          
            <li><a class="" href="/HD2MM_Linux.html">HD2MM on Linux</a></li>
          
            <li><a class=" active" href="/Darktide_EWC_Edits.html">Darktide Weapon Customization Edits</a></li>
          
        </ul>
      
    </nav>
    <!DOCTYPE html>
<html>
  <head>
    <meta name="description" content="Making adjustments to attachments for the Darktide Extended Weapon Customization mod.">
    <meta name="keywords" content="Darktide, 40k, Weapon Customization, Extended Weapon Customization, mods, modding">
    <title>Darktide: Making Weapon Customization Edits</title>
  </head>
  <body>
    <h1 class="ewc">Introduction</h1>
    This is a walkthrough on how to make edits to parts from the <a href="https://www.nexusmods.com/warhammer40kdarktide/mods/277">Extended Weapon Customization</a> (EWC) mod and any of its plugins for <i>Warhammer 40,000: Darktide</i>. I'm assuming you have a cursory knowledge of filesystems and are comfortable with installing mods for Darktide.<br>
    <h1 class="ewc">Requirements</h1>
    <ol>
      <li>Any text editor, preferably one with syntax highlighting. Notepad will work in a pinch, but programs such as Notepad++ or <a href="https://code.visualstudio.com/">Visual Studio Code</a> are much more powerful.</li>
      <li><a href="https://www.nexusmods.com/warhammer40kdarktide/mods/312">Modding Tools utility</a>. This adds a menu that lets you move each attachment and see the changes live.<br>
        Note that the Nexus version has a bug that will make you crash when you reload mods, which is fixed in the versions uploaded to the <a href="https://discord.com/channels/1048312349867646996/1252949356823314444">Modding Tools thread</a> in the Darktide Modders Discord. Why is it not on Nexus? I don't know.</li>
      <li>The <code>weapon_customization_plugin</code> template. Grasmann left a lot of notes in this plugin explaining what flags exist for making parts.<br>
        Even if you don't read this, it's needed for one of the methods for injecting fixes.<br>
        I'll let you go through this yourself, but the tl;dr is that each attachment has an id you give it and a mesh/model taken from the game, and equipping an attachment in a slot in the customization menu causes the mod to search for injected fixes that match the ids of any equipped attachment, which affects how the attachment looks. To get it, join the <a href="https://discord.gg/rKYWtaDx4D">Darktide Modders Discord</a>, go to the <code>#weapon-customization-mod</code> channel, and scroll way back to the <a href = "https://discord.com/channels/1048312349867646996/1168063453416669284/1170507811713728643">pinned message</a> containing the template archive.</li>
      <li>[Optional] Go to Mod Options --> Darktide Mod Framework --> Enable Developer Mode. This will let you reload mods (and see your fixes) without having to close the game. By default, you reload mods using <code>Ctrl + Shift + R</code>.</li>
    </ol>
    <h1 class="ewc">Walkthrough</h1>
    Here's a specific example. I equipped this combination of parts on a Force Greatsword; look at that ugly gap!<br>
    <img src="images/SwordGap1.png" alt="FGS gap 1" class="smol"><br>
    This does not spark joy! To fix it, I need to change the position values for the pommel. While I'm at it, I might as well move the hilt down a bit.<br>
    <h2 class="ewc">Injecting Fixes</h2>
    After fixes get injected, the mod searches for the first one that matches (from top down). The base mod and plugins will have their own fixes injected, but these are typically written for broad, generic cases. You could create your own fixes, and there's two options for where to keep them:
    <ol class="ewc">
      <li>Directly in one of the plugins</li>
      <li>In your own fixes-only plugin</li>
    </ol>
    I would ONLY put the fixes in one of the plugins if it's a simple, one-time thing and you're willing to risk losing it if you forget to transfer it over after the mod author update the plugin. You can quickly make a custom plugin using the template; I'll elaborate in this collapsed section. In my example screenshots, I'll be doing it through a separate plugin, but the general idea is the same. 
    <button type="button" class="collapsible">Making a basic plugin</button>
    <divPlugin class="content">
      Easiest way to do this is to copy over the template and strip it. Install the template as if it was a mod, then descend into the folders. Delete the <code>copy.cmd</code> script since you don't need that.<br>
      Delete EVERYTHING inside the "Inject attachment definitions" and "Inject attachment models" sections. Feel free to delete the comments (lines beginning with <code>--</code>) for "Inject attachment fixes" but that could be handy to reference later. Delete the "Inject sight" segment, but make sure you DON'T delete the <code>end</code>s.<br>
      <img src="images/StripPlugin1.png" alt="strip plugin"> <br>
      <img src="images/StripPlugin2.png" alt="strip plugin"> <br>
      <img src="images/StripPlugin3.png" alt="strip plugin"> <br>
      Feel free to change the name, but keep in mind that you'll need to rename the folders, the .mod and .lua files, and any mentions of the name within those files.<br>
      <br>
      Add this to your load order and launch the game to make sure it still works. If you get something like a "69 func: nil" error, you deleted too much and have a syntax error (messed up code structure).<br>
      I put this file below the main plugin but above the other plugins. It needs to be below the main plugin so that can create its anchor tables (which you're injecting into) first.<br>
      <br>
      You don't have to go this far, but here's is my ultra stripped version with some personal edits.<br>
      <img src="images/CustomPluginEmptyNoHomo.png" alt="strip plugin personal"> <br>
      First I did all the things I mentioned above, except I also cleared out the inject fixes section. I also cleared out the comments at the top. Then, I modified the <code>if statement</code>> so it exits the program if you're missing requirements. This means fixes are injected OUTSIDE the <code>if then end</code>, so <code>between</code> the two <code>end</code>s.<br>
      In the regular template, you inject fixes INSIDE the <code>if then end</code>, so <b>before</b> the two <code>end</code>s, because it does the opposite: only execute this code if the requirement is met.<br>
      <br>
    </divPlugin>
    Alright, now that you have a place to put the fixes, you need to actually make them. This starts with finding out which combination of parts you're using, then getting the attachment_id for each. Here's the customization options I chose for that Force Greatsword; I'm interested in the grip, pommel, and hilt. <br>
    <img src="images/CustomizationOptions.png" alt="FGS gap 2"> <br>
    <h3 class="ewc">Finding attachment_ids</h3>
    The first step is figuring out <b>which plugin the attachment came from</b> and making note of it the <b>attachment name</b>.<br>
    &emsp;Generally, the position on the list will tell you which one it's from. It goes <b>base mod --> plugins</b>, in reverse load order for the plugins.<br>
    &emsp;E.g. if you're using Syn's Edits and the MT plugin, the first options will be from the base mod, then there's the options from the MT plugin, then the options from Syn's plugin. This is because Syn's Edits comes before the MT plugin in the load order.<br>
    &emsp;Some plugins, namely the MT plugin, will have an indicator at the start of the name to clearly distinguish it.<br>
    Now that you know the attachment name and which plugin it's from, you can find the attachment_id. Within each plugin, the displayed name and attachment_id are kept in the same place.<br>
    &emsp;For the base mod, this is either in the common files in <code>&lt;Darktide Mods&gt;/weapon_customization/scripts/mods/weapon_customization/weapon_attachments</code> or deeper, within the individual weapon files in <code>functions/</code>. Note that the weapon names are the names based on the code. You'll also see individual weapon files in the first folder I mentioned; that's where fixes from the base mod are stored.<br>
    &emsp;For the MT plugin, these are in <code>&lt;Darktide Mods&gt;/weapon_customization_mt_stuff/common/melee.lua</code> and <code>&lt;Darktide Mods&gt;/weapon_customization_mt_stuff/common/ranged.lua</code>. Other plugins based on this will have a similar structure.<br>
    &emsp;You could also just use some search methods. These are <i>much</i> easier and faster, but I'll still go through the steps of doing it manually to be thorough.<br>
    <button type="button" class="collapsibleNotSoSmol">Search Methods</button>
    <divPlugin class="contentNotSoSmol">
      The easiest way is to search through VS Code. Drag the folder you want to search into VS Code, then open the search bar by clicking the magnifying glass on the left.<br>
      <img src="images/searchVSCode1.png" alt="vs code"><br>
      <img src="images/searchVSCode2.png" alt="vs code search"><br>
      Here's me searching all the files by using the command line (on Linux). <code>grep</code> searches for things in files, the <code>R</code> flag means search files within folders, and the <code>n</code> flag means it'll print the line number too. For a Windows equivalent, search the Internet I guess. 
      <img src="images/FindingAttachmentIdCLI.png" alt="grep"><br>
    </divPlugin><br>
    Going back to my example, I will start with finding the grip. I see that the name is "Power Sword 4" and it's a base mod attachment, so I'll go look in the <code>weapon_customization</code> mod folder. I go to <code>&lt;Darktide Mods&gt;/weapon_customization/scripts/mods/weapon_customization/weapon_attachments</code> and see <code>common_melee.lua</code>.<br>
    <img src="images/FindingAttachmentId1.png" alt="common_melee.lua in the folder" class="smol"><br>
    Now I'll do a quick search. <br>
    <img src="images/FindingAttachmentId2.png" alt="Power Sword grip 4"><br>
    Ah! "power_sword_grip_04" I'll make a note of that. Now that you have an idea of how it works, I'll find the rest of them in this spoiler: <button type="button" class="collapsible">More manual searching</button>
    <divPlugin class="content">
      Doing the same for the hilt, I find that it's "2h_force_sword_hilt_01".<br>
      I didn't see the pommel in this file, so I'll check the individual weapon file. I didn't find it, but I did find this:<br>
      <img src="images/FindingAttachmentId4.png" alt="pommels are in common"><br>
      Ok, that means it <i>was</i> in <code>common_melee.lua</code>, just not directly. I'll go back and look deeper.<br>
      <img src="images/FindingAttachmentId5.png" alt="pommels in common"><br>
      This part means that the common melee pommels includes all the pommels from the pommel_attachments table in all of these base files. Based on the names, the ones I've boxed are the most likely candidates. Therefore, I'll visit <code>&lt;Darktide Mods&gt;/weapon_customization/scripts/mods/weapon_customization/weapon_attachments/functions/</code> and search through each suspect.<br>
      Going through them all, turns out it's in the Crusher file, and it's called "2h_power_maul_pommel_03".<br>
      <img src="images/FindingAttachmentId8.png" alt="crusher 2h power maul file" class="smol"><br>
    </divPlugin><br>
    By now, you have the attachment_ids for all the relevant parts. You can now start actually making fixes.
    <h3 class="ewc">Creating and Injecting Fixes</h3>
    Within the <code>weapon_customization_plugin</code> template, you can find an example injection.<br>
    <img src="images/injectFixes1.png" alt="inject fixes"><br>
    Each weapon will require its own block (the square selection I made). Replace the weapon name, with the relevant weapon, then in the dependencies, put the relevant attachments. Separation by comma outside quotes means AND, having ! at the start means NOT, and being separated by | while inside quotes means OR.<br>
    My Force Greatsword was using "power_sword_grip_04" AND "2h_force_sword_hilt_01" AND "2h_power_maul_pommel_03", so that's what I'll put in the dependencies. The change in spacings doesn't matter.<br>
    <img src="images/injectFixes2.png" alt="inject fixes example"><br>
    If you're piggybacking off of an existing plugin, copy over the fixes WITHOUT the <code>table.prepend</code> stuff. Here is an example with the MT Plugin (and it's in the Devil's Claw Sword file but shush)<br>
    <img src="images/injectFixesMT.png" alt="inject fixes example MT"><br>
    I've also initialized the fixes with some default values. It's actually best if you don't use 0 for everything, but I'll do it this way to show why. Here's the (good) code for easy copy pasting:<br>
    &emsp;<code>{ position = vector3_box(0.0, 0.0, 0.01), rotation = vector3_box(0, 0, 0), scale = vector3_box(1.0, 1.0, 1.0)},</code><br>
    Alright, so how do you actually find out the values to put? If you're crazy, you could find the original fix values then purely mentally calculate the effects of each change. I don't know about you, but I am <i>not</i> built like that. This is where Modding Tools comes in.
    <br>
    Anyways, go back into the game and get to work. Open the cosmetics menu for your weapon, then press the button to Use Modding Tool.<br>
    <img src="images/MakingFixes1.png" alt="zeroed out sword" class="smol"><br>
    That looks even worse, but that will change. Click on one of the pieces and start moving it around. Make note of the number that shows up.<br>
    <img src="images/MakingFixes2.png" alt="zeroed out sword blob" class="smol"><br>
    That pommel looks much better! But wait! Why is there blob of options that I can't select properly? These are all parented to the same slot, so changes to the parent get inherited by the children. In this case, the blade, hilt, and pommel are all parented to the grip. This is why it's best to make the default values not just zeros throughout.<br>
    <br>
    You can't move the hilt if you can't click on it. So go back to the injected fixes, then change the position for the hilt by some arbitrary value (as an example, I made its position <code>(0.0, 0.2, 0.0)</code>, though <code>(0.0, 0.0, 0.1)</code> is less likely to go off screen).<br>
    Go back to the game, close the inventory, reload mods (or restart the game), then reopen the cosmetics menu.<br>
    <img src="images/MakingFixes3.png" alt="tilted out sword" class="smol"><br>
    ...Even uglier but now I can actually click things! Plus, now I know the blade is actually parented to the hilt, not the grip as I assumed (this is defined close to where you find the attachment_id but I'm lazy). I'll get that out of the way, then move the hilt to where I want it. Once it looks right, I'll copy over the values to the plugin. Do this for all relevant parts (don't worry, I moved the blade back down).<br>
    <img src="images/MakingFixes4.png" alt="copy fixes" class="notSoSmol"><br>
    Now close the inventory, reload or restart, and come back.<br>
    <img src="images/MakingFixes5.png" alt="fix sword" class="smol"><br>
    Yippee!!! I'm gonna make some more minor edits, but you get the gist by now. Astute readers may have noticed that I have edited the blade even though I didn't put any dependencies for blade. This means I'm changing <i>every</i> blade, as long as the pommel/hilt/grip group is equipped. It's fine in this case, but you may find yourself having to redo the fixes if another blade comes out.<br>
    <br>
    <img src="images/injectFixes3.png" alt="FGS no gap fixes"> <br>
    <img src="images/CustomPlugin.png" alt="plugin personal final"> <br>
    <img src="images/SwordGap2.png" alt="FGS no gap"> <br>
  </body>
</html>


    <style>
      nav ul {
        display: flex;
        list-style: "> ";
        list-style-position: inside;
        margin-top: 2px;
        margin-bottom: 2px;
      }
      nav ul li {
        margin-right: 10px;
      }
      nav ul li a {
        text-decoration: none;
      }
      nav h3 a {
        text-decoration: none;
      }
      nav ul li a:hover {
        text-decoration: underline;
      }
      /* Hyperlink for currently active page. Background color matches collapsible for navbar */
      .active {
        font-style: italic;
        background-color: #eee;
      }
      .navbarHeader {
        margin-top: 8px;
        margin-bottom: 8px;
      }
      /* Style the button that is used to open and close the collapsible content */
      .collapsible {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px 18px 18px 54px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
      }
      .collapsibleNotSoSmol {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px 18px 18px 18px;
        max-width: 60%;
        border: none;
        text-align: center;
        outline: none;
        font-size: 15px;
      }
      
      /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
      .active, .collapsible:hover {
        background-color: #ccc;
      }
      .active, .collapsibleNotSoSmol:hover {
        background-color: #ccc;
      }
      
      /* Style the collapsible content. Note: hidden by default */
      .content {
        padding: 0 18px;
        display: none;
        overflow: hidden;
        background-color: #f1f1f1;
      } 
      .contentNotSoSmol {
        max-width: 60%;
        padding: 0 18px;
        display: none;
        overflow: hidden;
        background-color: #f1f1f1;
      } 

      /* Gives body some left padding so it's not all cramped */
      /*.bodyContent */
      body {
        padding-left: 36px;
        padding-right: 36px;
      }

      /* Making the list in ewc edits page less spaced out */
      .ewc ol {
        margin: 2px;
      }
      .ewc ol li {
        margin: 2px;
      }
      /* I don't like how spaced out the titles are */
      .ewc {
        margin-bottom: 8px;
      }

      .notSoSmol {
        max-width: 60%;
        max-height: 100%;
      } 
      .smol {
        max-width: 40%;
        max-height: 100%;
      } 
      img {
        max-width: 100%;
        max-height: 100%;
      } 
    </style>
    
    <script>
      var coll = document.getElementsByClassName("collapsible");
      var i;
      
      for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
          }
        });
      }
    </script>
    <script>
      var coll = document.getElementsByClassName("collapsibleNotSoSmol");
      var i;
      
      for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
          }
        });
      }
    </script>
  </body>
</html>
